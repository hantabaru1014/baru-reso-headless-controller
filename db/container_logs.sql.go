// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: container_logs.sql

package db

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const deleteContainerLogsByHostID = `-- name: DeleteContainerLogsByHostID :exec
DELETE FROM container_logs
WHERE tag LIKE 'headless-' || $1 || '-%'
`

// 特定のホストIDに関連するすべてのログを削除
// タグは "headless-{hostID}-{instanceID}" の形式
func (q *Queries) DeleteContainerLogsByHostID(ctx context.Context, hostID pgtype.Text) error {
	_, err := q.db.Exec(ctx, deleteContainerLogsByHostID, hostID)
	return err
}

const getContainerLogsByTag = `-- name: GetContainerLogsByTag :many
SELECT id, tag, ts, data
FROM container_logs
WHERE tag = $1
  AND ($2::bigint IS NULL OR $2 = 0 OR id < $2)
  AND ($3::bigint IS NULL OR $3 = 0 OR id > $3)
ORDER BY id DESC
LIMIT CASE WHEN $4 > 0 THEN $4 ELSE 100 END
`

type GetContainerLogsByTagParams struct {
	Tag      pgtype.Text
	BeforeID int64
	AfterID  int64
	MaxRows  interface{}
}

type GetContainerLogsByTagRow struct {
	ID   pgtype.Int8
	Tag  pgtype.Text
	Ts   pgtype.Timestamp
	Data []byte
}

// 特定のタグ（hostID + instanceID）のログを取得
// before_id: このIDより小さいログ (古い方向へのページネーション)
// after_id: このIDより大きいログ (新しい方向へのページネーション)
func (q *Queries) GetContainerLogsByTag(ctx context.Context, arg GetContainerLogsByTagParams) ([]GetContainerLogsByTagRow, error) {
	rows, err := q.db.Query(ctx, getContainerLogsByTag,
		arg.Tag,
		arg.BeforeID,
		arg.AfterID,
		arg.MaxRows,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetContainerLogsByTagRow
	for rows.Next() {
		var i GetContainerLogsByTagRow
		if err := rows.Scan(
			&i.ID,
			&i.Tag,
			&i.Ts,
			&i.Data,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const insertContainerLog = `-- name: InsertContainerLog :exec
INSERT INTO container_logs (tag, ts, data) VALUES ($1, $2, $3)
`

type InsertContainerLogParams struct {
	Tag  pgtype.Text
	Ts   pgtype.Timestamp
	Data []byte
}

// テスト用
func (q *Queries) InsertContainerLog(ctx context.Context, arg InsertContainerLogParams) error {
	_, err := q.db.Exec(ctx, insertContainerLog, arg.Tag, arg.Ts, arg.Data)
	return err
}
